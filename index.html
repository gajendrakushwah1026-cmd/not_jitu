<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduVault | Shared Study Vault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f3f4f6;
            scroll-behavior: smooth;
        }
        .glass-card { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .video-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 2rem; 
        }
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .scale-up-animation {
            animation: scaleIn 0.2s ease-out forwards;
        }
    </style>
</head>
<body class="min-h-screen pb-12">

<!-- Admin Status Bar -->
<div id="adminStatusBar" class="hidden bg-indigo-900 text-white text-[10px] md:text-xs py-1.5 text-center font-bold tracking-widest uppercase">
    Admin Mode Active â€¢ Videos you add will be visible to everyone
</div>

<!-- Header -->
<header class="sticky top-0 z-40 bg-white/70 backdrop-blur-md border-b border-gray-200 px-4 md:px-6 py-4">
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 p-2 rounded-xl shadow-lg shadow-indigo-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
            </div>
            <h1 class="text-2xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-indigo-700 to-purple-700">EduVault</h1>
        </div>

        <div class="flex items-center gap-3 w-full md:w-auto">
            <div class="relative w-full md:w-80">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </span>
                <input id="searchInput" type="text" placeholder="Search topics..." class="pl-10 pr-4 py-2.5 rounded-2xl w-full border-0 bg-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
            </div>
            
            <button id="authBtn" onclick="toggleAuthModal()" class="flex-shrink-0 bg-white border border-gray-200 shadow-sm text-gray-700 px-4 py-2.5 rounded-2xl font-semibold hover:bg-gray-50 transition-all flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span id="authBtnText">Admin</span>
            </button>

            <button onclick="openVideoModal()" id="addVideoBtn" class="hidden flex-shrink-0 bg-indigo-600 text-white px-5 py-2.5 rounded-2xl font-semibold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"></path></svg>
                Add
            </button>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto p-6">
    <div id="loadingStatus" class="text-center py-10 text-gray-500 font-medium">Loading resources...</div>
    
    <!-- Category Pills -->
    <div id="categoryWrapper" class="hidden mb-8">
        <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4 ml-1">Subjects</h2>
        <div id="subjectFilters" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- Video Grid -->
    <div id="videoContainer" class="video-grid"></div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden flex flex-col items-center justify-center py-32 text-center">
        <div class="bg-gray-200 p-6 rounded-full mb-4">
            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800">No videos yet</h3>
        <p class="text-gray-500 mt-2">Public videos will appear here once added by Admin.</p>
    </div>
</main>

<!-- Auth Modal -->
<div id="authModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-[100] p-4">
    <div class="bg-white rounded-3xl w-full max-w-sm p-8 shadow-2xl scale-up-animation">
        <div class="text-center mb-6">
            <div class="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">Admin Login</h2>
            <p class="text-gray-500 text-sm mt-1">Only Jitu can add or delete videos.</p>
        </div>
        <div class="space-y-4">
            <input id="adminPass" type="password" class="w-full border-2 border-gray-100 bg-gray-50 p-3 rounded-2xl focus:border-indigo-500 outline-none transition-all" placeholder="Enter Password" onkeypress="if(event.key === 'Enter') handleLogin()" />
            <div class="flex gap-3 pt-2">
                <button onclick="toggleAuthModal()" class="flex-1 py-3 text-gray-600 font-semibold hover:bg-gray-100 rounded-2xl transition-all">Cancel</button>
                <button onclick="handleLogin()" class="flex-1 bg-indigo-600 text-white py-3 rounded-2xl font-semibold hover:bg-indigo-700 shadow-lg shadow-indigo-100">Unlock</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Video Modal -->
<div id="videoModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-[100] p-4">
    <div class="bg-white rounded-3xl w-full max-w-lg p-8 shadow-2xl scale-up-animation">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Publish to Public</h2>
        <div class="space-y-5">
            <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1 ml-1">Title</label>
                <input id="vTitle" class="w-full bg-gray-50 border-0 p-3 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="e.g. Physics Chapter 1" />
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1 ml-1">Subject</label>
                <input id="vSubject" class="w-full bg-gray-50 border-0 p-3 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="e.g. Physics" />
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1 ml-1">YouTube Link</label>
                <input id="vUrl" class="w-full bg-gray-50 border-0 p-3 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="Paste link here" />
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button onclick="closeVideoModal()" class="px-6 py-3 text-gray-500 font-semibold hover:bg-gray-100 rounded-2xl">Discard</button>
                <button id="saveBtn" onclick="saveVideo()" class="bg-indigo-600 text-white px-8 py-3 rounded-2xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition-all">Publish Video</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

// Firebase Configuration
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'eduvault-pro-app';

let videos = [];
let isAdmin = false;
let currentFilter = 'All';
const ADMIN_PASSWORD = "Jitu9027";

// Correct Firestore Collection Path according to mandatory rules
const getCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'videos');

// 1. Auth Setup (Mandatory Rule 3)
async function init() {
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    } catch (err) {
        console.error("Auth Error:", err);
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            setupRealtimeUpdates();
        }
    });
}

// 2. Realtime Data Sync
function setupRealtimeUpdates() {
    const q = getCollection();
    
    // onSnapshot with success and error callbacks (Mandatory requirement)
    onSnapshot(q, (snapshot) => {
        videos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        // Local sort (Mandatory Rule 2: No complex queries/orderBy in Firestore)
        videos.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
        
        const loadingStatus = document.getElementById('loadingStatus');
        const categoryWrapper = document.getElementById('categoryWrapper');
        if (loadingStatus) loadingStatus.classList.add('hidden');
        if (categoryWrapper) categoryWrapper.classList.remove('hidden');
        render();
    }, (error) => {
        console.error("Firestore Permission/Fetch Error:", error);
        const loadingStatus = document.getElementById('loadingStatus');
        if (loadingStatus) loadingStatus.innerText = "Error: Please ensure your hosting environment allows Firebase connections.";
    });
}

// 3. Admin Actions
window.handleLogin = () => {
    const passInput = document.getElementById('adminPass');
    if(passInput.value === ADMIN_PASSWORD) {
        isAdmin = true;
        toggleAdminUI(true);
        document.getElementById('authModal').classList.add('hidden');
        passInput.value = '';
    } else {
        alert('Incorrect Password!');
    }
};

window.saveVideo = async () => {
    if (!auth.currentUser) {
        alert("Please wait for authentication...");
        return;
    }

    const title = vTitle.value.trim();
    const subject = vSubject.value.trim();
    const url = vUrl.value.trim();
    const match = url.match(/(?:v=|\/|embed\/|youtu.be\/)([0-9A-Za-z_-]{11})/);
    const ytId = match ? match[1] : null;

    if(!title || !subject || !ytId) {
        alert('Invalid data or link');
        return;
    }

    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;
    saveBtn.innerText = "Publishing...";

    try {
        await addDoc(getCollection(), {
            title, subject, url, ytId,
            createdAt: Date.now()
        });
        vTitle.value = vSubject.value = vUrl.value = '';
        closeVideoModal();
    } catch (e) {
        console.error("Save Error:", e);
        alert("Permission Denied or Network Error while saving.");
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerText = "Publish Video";
    }
};

window.deleteVideo = async (docId) => {
    if (!auth.currentUser) return;
    if(confirm('Delete this video for everyone?')) {
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'videos', docId));
        } catch (e) {
            alert("Error deleting: Permission Denied.");
        }
    }
};

// 4. UI Rendering
window.render = () => {
    const videoContainer = document.getElementById('videoContainer');
    const subjectFilters = document.getElementById('subjectFilters');
    const searchInput = document.getElementById('searchInput');
    const search = searchInput ? searchInput.value.toLowerCase() : "";

    // Filters
    const uniqueSubjects = [...new Set(videos.map(v => v.subject))];
    const subjects = ['All', ...uniqueSubjects];
    subjectFilters.innerHTML = subjects.map(s => `
        <button onclick="window.filterVideos('${s}')" 
            class="px-5 py-2 rounded-2xl text-sm font-bold transition-all
            ${currentFilter === s 
                ? 'bg-indigo-600 text-white shadow-lg' 
                : 'bg-white text-gray-500 border border-gray-100'}">
            ${s}
        </button>
    `).join('');

    // Filter Logic
    const filtered = videos.filter(v =>
        (currentFilter === 'All' || v.subject === currentFilter) &&
        (v.title.toLowerCase().includes(search) || v.subject.toLowerCase().includes(search))
    );

    const emptyState = document.getElementById('emptyState');
    emptyState.classList.toggle('hidden', filtered.length !== 0);
    videoContainer.innerHTML = '';

    filtered.forEach(v => {
        const thumb = `https://img.youtube.com/vi/${v.ytId}/mqdefault.jpg`;
        const div = document.createElement('div');
        div.className = "group glass-card rounded-[2.5rem] overflow-hidden hover:shadow-2xl transition-all border border-white scale-up-animation";
        div.innerHTML = `
            <div class="relative aspect-video">
                <img src="${thumb}" class="w-full h-full object-cover">
                <div class="absolute top-4 right-4 bg-white/90 px-3 py-1 rounded-full text-[10px] font-bold text-indigo-700 shadow-sm">${v.subject}</div>
            </div>
            <div class="p-6">
                <h3 class="font-bold text-gray-800 text-lg leading-tight mb-4 line-clamp-2 h-12">${v.title}</h3>
                <div class="flex items-center justify-between">
                    <a href="${v.url}" target="_blank" class="flex items-center gap-2 bg-indigo-600 text-white px-5 py-2.5 rounded-2xl text-sm font-bold hover:bg-indigo-700 transition-all">
                        Watch Now
                    </a>
                    ${isAdmin ? `
                        <button onclick="window.deleteVideo('${v.id}')" class="p-2.5 text-red-400 hover:text-red-600 transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
        videoContainer.appendChild(div);
    });
};

// Global Helpers for HTML onclicks
window.toggleAuthModal = () => {
    if(isAdmin) { isAdmin = false; toggleAdminUI(false); return; }
    document.getElementById('authModal').classList.toggle('hidden');
};
window.openVideoModal = () => document.getElementById('videoModal').classList.remove('hidden');
window.closeVideoModal = () => document.getElementById('videoModal').classList.add('hidden');
window.filterVideos = (sub) => { currentFilter = sub; window.render(); };

function toggleAdminUI(state) {
    document.getElementById('addVideoBtn').classList.toggle('hidden', !state);
    document.getElementById('adminStatusBar').classList.toggle('hidden', !state);
    document.getElementById('authBtnText').innerText = state ? 'Logout' : 'Admin';
    window.render();
}

document.getElementById('searchInput').addEventListener('input', window.render);
init();
</script>
</body>
</html>